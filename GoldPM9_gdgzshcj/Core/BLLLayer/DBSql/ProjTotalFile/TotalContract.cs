#region <auto-generated>
//此代码由T4模板自动生成 
//生成时间 2016-07-12 14:56:40
#endregion
using System;
using System.Collections.Generic;
using System.Linq;
using System.Linq.Expressions;
using System.Text;
using Common.Data;
using Common.Data.Extenstions;
using DAL;
using System.Data;
using System.Data.SqlClient;
using System.Collections;
using System.Data.Entity;

namespace DBSql.ProjTotalFile
{
    public class TotalContract : EFRepository<DataModel.Models.TotalContract>
    {
        /// <summary>
        /// 判断是否有重名的合同编号
        /// </summary>
        /// <param name="TotalContractNumber"></param>
        /// <param name="Id"></param>
        /// <returns></returns>
        public int GetTotalContractNumberCount(string TotalContractNumber, int Id = 0)
        {
            int Res = 0;
            string sql = "select count(*) from TotalContract where TotalContractNumber=@TotalContractNumber and DeleterEmpId = 0 ";

            if (Id > 0)
            {
                sql += " and Id!=" + Id;
            }

            SqlParameter[] sqlp = {
                new SqlParameter("@TotalContractNumber",SqlDbType.NVarChar)
            };
            sqlp[0].Value = TotalContractNumber.Trim();
            try
            {
                Res = Convert.ToInt32(DBExecute.ExecuteScalar(sql, sqlp));
            }
            catch { }
            return Res;
        }
        public DataTable GetTotalContractList(Common.SqlPageInfo condition)
        {
            string RowColumn = " *,";
            RowColumn += "(select basename from basedata where baseid=c.TotalContractStatusID) as StatusName,";
            if (condition.SelectCondtion["ShowTypeName"] != null)
            {
                RowColumn += "(select basename from basedata where baseid=c.TotalContractTypeID) as TypeName,";
            }
            RowColumn += "(select isnull(sum(fee),0) from TotalContractFeeFact where TotalContractID=c.TotalContractID ) as PayFee,";//已收款
            RowColumn += "(TotalContractFee-(select isnull(sum(Fee),0) from TotalContractFeeFact where TotalContractID=c.TotalContractID))as notfee, ";//未收款
            RowColumn += "((select isnull(sum(Fee),0) from TotalContractFeePlan where TotalContractID=c.TotalContractID and IsFinished=1)-(select isnull(sum(Fee),0) from TotalContractFeeFact where TotalContractID=c.TotalContractID))as canfee,";//可收未收   
            RowColumn += "(select isnull(sum(fee),0) from TotalContractFeePlan where TotalContractID=c.TotalContractID ) as InvoiceFee ";//计划收费
            if (condition.SelectCondtion["ShowAlreadyInvoice"] != null)
            {
                RowColumn += ",(select isnull(sum(ConFeeInvoiceFee),0) from TotalContractInvoice where TotalContractID=c.TotalContractID) as AlreadyInvoice";    //已开票
            }
            StringBuilder strSql = new StringBuilder();
            strSql.Append("Select Count(1) from TotalContract c where 1=1 ");

            SqlParameter[] Parameters = {
                 new SqlParameter("@condition",SqlDbType.VarChar),
                 new SqlParameter("@DateLower",SqlDbType.SmallDateTime),
                 new SqlParameter("@DateUpper",SqlDbType.SmallDateTime),
                 new SqlParameter("@Proj0ID",SqlDbType.Int),
                 new SqlParameter("@ConStatusID",SqlDbType.Int),
            };


            if (condition.TextCondtion != null && condition.TextCondtion != "")
            {
                strSql.Append("  AND (TotalContractName LIKE '%'+@condition+'%' or TotalContractNumber  LIKE '%'+@condition+'%')");
                Parameters[0].Value = condition.TextCondtion;
            }
            if (condition.SelectCondtion != null && condition.SelectCondtion.Count > 0)
            {
                foreach (DictionaryEntry de in condition.SelectCondtion)
                {
                    if (de.Value == null || de.Value.ToString().Trim() == "") continue;

                    switch (de.Key.ToString())
                    {
                        case "DateUpper":
                            {
                                if (de.Value.ToString() != "")
                                {
                                    strSql.Append(" AND convert(datetime,convert(varchar(10),TotalContractDate,111))<=@DateLower");
                                    Parameters[2].Value = DateTime.Parse(de.Value.ToString());
                                }
                            }
                            break;

                        case "DateLower":
                            {
                                if (de.Value.ToString() != "")
                                {
                                    strSql.Append(" AND convert(datetime,convert(varchar(10),TotalContractDate,111))>=@DateLower");
                                    Parameters[1].Value = DateTime.Parse(de.Value.ToString());

                                }
                            }
                            break;
                        case "FeeStatus":
                            {
                                if (de.Value.ToString() != "0")
                                {
                                    if (de.Value.ToString() == "1")//未付
                                        strSql.Append(" and (select isnull(sum(fee),0) from TotalContractFeeFact where TotalContractID=c.TotalContractID )=0");
                                    if (de.Value.ToString() == "2")//部分付
                                        strSql.Append(" and (select isnull(sum(fee),0) from TotalContractFeeFact where TotalContractID=c.TotalContractID )>0 and (select isnull(sum(fee),0) from TotalContractFeeFact where TotalContractID=c.TotalContractID )<TotalContractFee");
                                    if (de.Value.ToString() == "3")//付清
                                        strSql.Append(" and (select isnull(sum(fee),0) from TotalContractFeeFact where TotalContractID=c.TotalContractID )>0 and (select isnull(sum(fee),0) from TotalContractFeeFact where TotalContractID=c.TotalContractID )>=TotalContractFee");
                                    if (de.Value.ToString() == "4")//可收未收 计划收费>实际收费
                                        strSql.Append(" and (select isnull(sum(fee),0) from TotalContractFeePlan where TotalContractID=c.TotalContractID )>(select isnull(sum(fee),0) from TotalContractFeeFact where TotalContractID=c.TotalContractID ) ");
                                }
                            }
                            break;
                        case "InvoiceStatus":
                            {
                                if (de.Value.ToString() != "0")
                                {
                                    if (de.Value.ToString() == "1")//发票欠收
                                        strSql.Append(" and (select isnull(sum(fee),0) from TotalContractFeeTotalInvoice where TotalContractID=c.TotalContractID )>(select isnull(sum(fee),0) from TotalContractFeeFact where TotalContractID=c.TotalContractID )");
                                    if (de.Value.ToString() == "2")//发票多收
                                        strSql.Append(" and (select isnull(sum(fee),0) from TotalContractFeeTotalInvoice where TotalContractID=c.TotalContractID )<(select isnull(sum(fee),0) from TotalContractFeeFact where TotalContractID=c.TotalContractID )");
                                    if (de.Value.ToString() == "3")//票额相等
                                        strSql.Append(" and (select isnull(sum(fee),0) from TotalContractFeeTotalInvoice where TotalContractID=c.TotalContractID )=(select isnull(sum(fee),0) from TotalContractFeeFact where TotalContractID=c.TotalContractID ) and (select isnull(sum(fee),0) from TotalContractFeeFact where TotalContractID=c.TotalContractID )>0");

                                }
                            }
                            break;
                        case "ConStatus":
                            {
                                if (de.Value.ToString() != "0")
                                {
                                    strSql.Append(" and ConStatusID=@ConStatusID");
                                    Parameters[4].Value = Convert.ToInt32(de.Value);
                                }
                            }
                            break;
                        case "ConType":
                            if (de.Value.ToString() != "0")
                            {
                                strSql.Append(" and TotalContractTypeID=@ConTypeID");
                                Parameters[5].ParameterName = "@ConTypeID";
                                Parameters[5].Value = de.Value;
                            }
                            break;
                        default:
                            break;
                    }
                }
            }
            //---------------- 得到总记录数-------------------------//
            object obj = DBExecute.ExecuteScalar(DBExecute.ConnectionString, strSql.ToString(), Parameters);

            if (obj == null && obj == DBNull.Value) condition.PageTotleRowCount = 0;
            else condition.PageTotleRowCount = Convert.ToInt32(obj);
            //------------------------------------------------------//

            if (String.IsNullOrEmpty(condition.SelectOrder))
            {
                condition.SelectOrder = " TotalContractDate desc";
            }

            string sql = Helper.SqlPage.ExecPageStrSql(condition, RowColumn, strSql);

            return DBExecute.ExecuteDataTable(DBExecute.ConnectionString, sql.ToString(), Parameters);
        }
    }
}
