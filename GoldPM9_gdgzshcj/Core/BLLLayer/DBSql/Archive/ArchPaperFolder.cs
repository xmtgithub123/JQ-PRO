#region <auto-generated>
//此代码由T4模板自动生成 
//生成时间 2017-04-20 09:39:00
#endregion
using System;
using System.Collections.Generic;
using System.Linq;
using System.Linq.Expressions;
using System.Text;
using Common.Data;
using Common.Data.Extenstions;
using DAL;
using System.Data;
using System.Collections;

namespace DBSql.Archive
{
    public class ArchPaperFolder : EFRepository<DataModel.Models.ArchPaperFolder>
    {
        /// <summary>
        /// 获取纸质文档树形节点
        /// </summary>
        /// <param name="id"></param>
        /// <param name="type"></param>
        /// <returns></returns>
        public DataTable GetTreeInfo(int id)
        {
            StringBuilder strSql = new StringBuilder();
            strSql.Append("select GId,Id,Name,Number,NumberShow,Type,case ParentId when '0' then case Type when -1 then '0' else GId end else ParentId end as ParentId  from (");
            strSql.AppendFormat(" select 'P_'+CAST(Id AS varchar) as GId,Id,'[工程] '+ProjName as Name,ArchNumber as Number,'[工程] ' + ArchNumber AS NumberShow,'0' as ParentId,-1 as Type from ArchPaperFolder a where Id={0}", id);
            strSql.Append(" union ");
            strSql.AppendFormat(" select 'F_'+CAST(Id AS varchar) as GId,Id,case Type when 0 then '档案：['+Number+'] '+Name when 1 then '设计文件：['+Number+'] '+Name when 2 then Name end as Name,Number,case Type when 0 then '档案：['+Number+'] '+Name when 1 then '设计文件：['+Number+'] '+Name when 2 then Number end as NumberShow,case ParentId when 0 then 'P_'+CAST(ArchPaperFolderId as varchar) else 'F_'+CAST(ParentId as varchar) end as ParentId,Type from ArchPaperFolderType b where ArchPaperFolderId={0}", id);
            strSql.Append(" ) x");

            
            return DBExecute.ExecuteDataTable(strSql.ToString());

        }

        public DataTable GetListByWhere(Common.SqlPageInfo queryContext)
        {
            string RowColumn = "*";
            StringBuilder strSql = new StringBuilder();
            strSql.Append("SELECT Count(1) FROM dbo.ArchPaperFolder WHERE 1=1 ");

            if (!string.IsNullOrEmpty(queryContext.TextCondtion))
            {
                strSql.AppendFormat(" and (ProjNumber like '%{0}%' or ProjName like '%{0}%' or ArchNumber like '%{0}%' or ProjPhaseName like '%{0}%' or Path like '%{0}%' or Remark like '%{0}%' or Id in (SELECT AttachRefID FROM dbo.BaseAttach  WHERE AttachRefTable='ArchPaperFolder' AND AttachName LIKE '%{0}%') or Id in (SELECT ArchPaperFolderId FROM dbo.ArchPaperFolderType WHERE Id IN (SELECT FlderId FROM dbo.ArchShareFolderML WHERE Id in ( SELECT AttachRefID FROM dbo.BaseAttach  WHERE AttachRefTable = 'ArchShareFolderML' AND AttachName LIKE '%{0}%'))))", queryContext.TextCondtion);
            }

            if (queryContext.SelectCondtion != null && queryContext.SelectCondtion.Count > 0)
            {
                foreach (DictionaryEntry de in queryContext.SelectCondtion)
                {
                    if (de.Value == null || de.Value.ToString().Trim() == "") continue;

                    switch (de.Key.ToString())
                    {
                        case "Year":
                            if (de.Value.ToString() != "0")
                            {
                                if (Convert.ToInt32(de.Value.ToString()) > 0)
                                {
                                    strSql.AppendFormat(" and ArchNumber LIKE 'F12-01-{0}%' ", de.Value);
                                }
                                else
                                {
                                    strSql.Append(" and ArchNumber LIKE 'F12-01%' ");
                                }
                            }
                            break;
                        default:
                            break;
                    }
                }
            }

            //---------------- 得到总记录数-------------------------//
            object obj = DBExecute.ExecuteScalar(DBExecute.ConnectionString, strSql.ToString());

            if (obj == null && obj == DBNull.Value) queryContext.PageTotleRowCount = 0;
            else queryContext.PageTotleRowCount = Convert.ToInt32(obj);
            //------------------------------------------------------//

            if (String.IsNullOrEmpty(queryContext.SelectOrder))
            {
                queryContext.SelectOrder = " ArchNumber desc";
            }

            string sql = Helper.SqlPage.ExecPageStrSql(queryContext, RowColumn, strSql);

            return DBExecute.ExecuteDataTable(DBExecute.ConnectionString, sql.ToString());
        }

        /// <summary>
        /// 获取纸质档案最大编号
        /// </summary>
        /// <returns></returns>
        public string GetMaxArchNumber()
        {
            string sql = @"SELECT  ISNULL('F12-01-' + CAST(YEAR(GETDATE()) AS NVARCHAR) + '-'
                                   + RIGHT('0000'
                                           + CAST(( MAX(RIGHT(ArchNumber, 4)) + 1 ) AS NVARCHAR),
                                           4),
                                   'F12-01-' + CAST(YEAR(GETDATE()) AS NVARCHAR) + '-0001') AS ArchNumber
                    FROM    ArchPaperFolder
                    WHERE   SUBSTRING(ArchNumber, 8, 4) = CAST(YEAR(GETDATE()) AS NVARCHAR)
                            AND ISNUMERIC(RIGHT(ArchNumber, 4)) = 1";

            return DBExecute.ExecuteScalar(sql).ToString();
        }
    }
}
